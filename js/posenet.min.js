// @tensorflow/tfjs-models Copyright 2019 Google
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@tensorflow/tfjs-core"),require("@tensorflow/tfjs-converter")):"function"==typeof define&&define.amd?define(["exports","@tensorflow/tfjs-core","@tensorflow/tfjs-converter"],t):t(e.posenet={},e.tf,e.tf)}(this,function(e,t,r){"use strict";var n=[8,16,32];var o=function(){function e(e,r,n){this.model=e;var o=this.model.inputs[0].shape;t.util.assert(!(o[1]!==r&&-1!==o[1]||o[2]!==r&&-1!==o[2]),function(){return"Input shape ["+o[1]+", "+o[2]+"] must both be equal to "+r+" or -1"}),this.inputResolution=r,this.outputStride=n}return e.prototype.predict=function(e){var r=this;return t.tidy(function(){var n=function(e){return t.tidy(function(){return"int32"===e.dtype&&(e=e.toFloat()),e=t.div(e,127.5),t.sub(e,1)})}(e).expandDims(0),o=r.model.predict(n),i=o[0],u=o[1],s=o[2],a=o[3];return{heatmapScores:u.squeeze().sigmoid(),offsets:i.squeeze(),displacementFwd:s.squeeze(),displacementBwd:a.squeeze()}})},e.prototype.dispose=function(){this.model.dispose()},e}();function i(e){return Math.floor(e/2)}var u=function(){function e(e,t){this.priorityQueue=new Array(e),this.numberOfElements=-1,this.getElementValue=t}return e.prototype.enqueue=function(e){this.priorityQueue[++this.numberOfElements]=e,this.swim(this.numberOfElements)},e.prototype.dequeue=function(){var e=this.priorityQueue[0];return this.exchange(0,this.numberOfElements--),this.sink(0),this.priorityQueue[this.numberOfElements+1]=null,e},e.prototype.empty=function(){return-1===this.numberOfElements},e.prototype.size=function(){return this.numberOfElements+1},e.prototype.all=function(){return this.priorityQueue.slice(0,this.numberOfElements+1)},e.prototype.max=function(){return this.priorityQueue[0]},e.prototype.swim=function(e){for(;e>0&&this.less(i(e),e);)this.exchange(e,i(e)),e=i(e)},e.prototype.sink=function(e){for(;2*e<=this.numberOfElements;){var t=2*e;if(t<this.numberOfElements&&this.less(t,t+1)&&t++,!this.less(e,t))break;this.exchange(e,t),e=t}},e.prototype.getValueAt=function(e){return this.getElementValue(this.priorityQueue[e])},e.prototype.less=function(e,t){return this.getValueAt(e)<this.getValueAt(t)},e.prototype.exchange=function(e,t){var r=this.priorityQueue[e];this.priorityQueue[e]=this.priorityQueue[t],this.priorityQueue[t]=r},e}();function s(e,t,r,n,o,i){for(var u=i.shape,s=u[0],a=u[1],l=!0,c=Math.max(r-o,0),f=Math.min(r+o+1,s),h=c;h<f;++h){for(var d=Math.max(n-o,0),p=Math.min(n+o+1,a),m=d;m<p;++m)if(i.get(h,m,e)>t){l=!1;break}if(!l)break}return l}var a=["nose","leftEye","rightEye","leftEar","rightEar","leftShoulder","rightShoulder","leftElbow","rightElbow","leftWrist","rightWrist","leftHip","rightHip","leftKnee","rightKnee","leftAnkle","rightAnkle"],l=a.length,c=a.reduce(function(e,t,r){return e[t]=r,e},{}),f=[["nose","leftEye"],["leftEye","leftEar"],["nose","rightEye"],["rightEye","rightEar"],["nose","leftShoulder"],["leftShoulder","leftElbow"],["leftElbow","leftWrist"],["leftShoulder","leftHip"],["leftHip","leftKnee"],["leftKnee","leftAnkle"],["nose","rightShoulder"],["rightShoulder","rightElbow"],["rightElbow","rightWrist"],["rightShoulder","rightHip"],["rightHip","rightKnee"],["rightKnee","rightAnkle"]],h=[["leftHip","leftShoulder"],["leftElbow","leftShoulder"],["leftElbow","leftWrist"],["leftHip","leftKnee"],["leftKnee","leftAnkle"],["rightHip","rightShoulder"],["rightElbow","rightShoulder"],["rightElbow","rightWrist"],["rightHip","rightKnee"],["rightKnee","rightAnkle"],["leftShoulder","rightShoulder"],["leftHip","rightHip"]].map(function(e){var t=e[0],r=e[1];return[c[t],c[r]]});function d(e,t,r,n){return{y:n.get(e,t,r),x:n.get(e,t,r+l)}}function p(e,t,r){var n=d(e.heatmapY,e.heatmapX,e.id,r),o=n.y,i=n.x;return{x:e.heatmapX*t+i,y:e.heatmapY*t+o}}function m(e,t,r){return e<t?t:e>r?r:e}function g(e,t){return{x:e.x+t.x,y:e.y+t.y}}var v=f.map(function(e){var t=e[0],r=e[1];return[c[t],c[r]]}),y=v.map(function(e){return e[1]}),b=v.map(function(e){return e[0]});function w(e,t,r,n){return{y:m(Math.round(e.y/t),0,r-1),x:m(Math.round(e.x/t),0,n-1)}}function x(e,t,r,n,o,i,u,s){void 0===s&&(s=2);for(var l=n.shape,c=l[0],f=l[1],h=function(e,t,r){var n=r.shape[2]/2;return{y:r.get(t.y,t.x,e),x:r.get(t.y,t.x,n+e)}}(e,w(t.position,i,c,f),u),p=g(t.position,h),m=0;m<s;m++){var v=w(p,i,c,f),y=d(v.y,v.x,r,o);p=g({x:v.x*i,y:v.y*i},{x:y.x,y:y.y})}var b=w(p,i,c,f),x=n.get(b.y,b.x,r);return{position:p,part:a[r],score:x}}function _(e,t,r,n,o,i){var u=t.shape[2],s=y.length,l=new Array(u),c=e.part,f=e.score,h=p(c,n,r);l[c.id]={score:f,part:a[c.id],position:h};for(var d=s-1;d>=0;--d){var m=y[d],g=b[d];l[m]&&!l[g]&&(l[g]=x(d,l[m],g,t,r,n,i))}for(d=0;d<s;++d){m=b[d],g=y[d];l[m]&&!l[g]&&(l[g]=x(d,l[m],g,t,r,n,o))}return l}function E(e,t,r,n){var o=r.x,i=r.y;return e.some(function(e){var r,u,s,a,l,c,f=e.keypoints[n].position;return r=i,u=o,s=f.y,a=f.x,(l=s-r)*l+(c=a-u)*c<=t})}function M(e,t,r){return r.reduce(function(r,n,o){var i=n.position,u=n.score;return E(e,t,i,o)||(r+=u),r},0)/r.length}var S=1;function k(e,t,r,n,o,i,a,l){void 0===a&&(a=.5),void 0===l&&(l=20);for(var c=[],f=function(e,t,r){for(var n=r.shape,o=n[0],i=n[1],a=n[2],l=new u(o*i*a,function(e){return e.score}),c=0;c<o;++c)for(var f=0;f<i;++f)for(var h=0;h<a;++h){var d=r.get(c,f,h);d<e||s(h,d,c,f,t,r)&&l.enqueue({score:d,part:{heatmapY:c,heatmapX:f,id:h}})}return l}(a,S,e),h=l*l;c.length<i&&!f.empty();){var d=f.dequeue();if(!E(c,h,p(d.part,o,t),d.part.id)){var m=_(d,e,t,o,r,n),g=M(c,h,m);c.push({keypoints:m,score:g})}}return c}function q(e,t,r,n){return new(r||(r=Promise))(function(o,i){function u(e){try{a(n.next(e))}catch(e){i(e)}}function s(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){e.done?o(e.value):new r(function(t){t(e.value)}).then(u,s)}a((n=n.apply(e,t||[])).next())})}function I(e,t){var r,n,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,n=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!(o=(o=u.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}var R=Number.NEGATIVE_INFINITY,O=Number.POSITIVE_INFINITY;function N(e){return e.reduce(function(e,t){var r=e.maxX,n=e.maxY,o=e.minX,i=e.minY,u=t.position,s=u.x,a=u.y;return{maxX:Math.max(r,s),maxY:Math.max(n,a),minX:Math.min(o,s),minY:Math.min(i,a)}},{maxX:R,maxY:R,minX:O,minY:O})}function B(e,r){return void 0===r&&(r="float32"),q(this,void 0,void 0,function(){var n;return I(this,function(o){switch(o.label){case 0:return[4,e.data()];case 1:return n=o.sent(),[2,t.buffer(e.shape,r,n)]}})})}function T(e,t,r,n,o){return void 0===n&&(n=0),void 0===o&&(o=0),{score:e.score,keypoints:e.keypoints.map(function(e){var i=e.score,u=e.part,s=e.position;return{score:i,part:u,position:{x:s.x*r+o,y:s.y*t+n}}})}}function z(e){return e instanceof t.Tensor?[e.shape[0],e.shape[1]]:[e.height,e.width]}function H(e,r,n){var o=r[0],i=r[1];void 0===n&&(n=!1);var u=z(e),s=u[0],a=u[1],l=i/o,c=[0,0,0,0],f=c[0],h=c[1],d=c[2],p=c[3];a/s<l?(f=0,h=0,d=Math.round(.5*(l*s-a)),p=Math.round(.5*(l*s-a))):(f=Math.round(.5*(1/l*a-s)),h=Math.round(.5*(1/l*a-s)),d=0,p=0);var m=function(e){return e instanceof t.Tensor?e:t.browser.fromPixels(e)}(e);return m=t.pad3d(m,[[f,h],[d,p],[0,0]]),{resized:n?m.reverse(1).resizeBilinear([o,i]):m.resizeBilinear([o,i]),paddedBy:[[f,h],[d,p]]}}function j(e){var r=e.shape,n=r[0],o=r[1],i=r[2];return t.tidy(function(){var r,u,s=e.reshape([n*o,i]).argMax(0),a=s.div(t.scalar(o,"int32")).expandDims(1),l=(r=s,u=o,t.tidy(function(){var e=r.div(t.scalar(u,"int32"));return r.sub(e.mul(t.scalar(u,"int32")))})).expandDims(1);return t.concat([a,l],1)})}function A(e,t,r,n){return{y:n.get(e,t,r),x:n.get(e,t,r+l)}}function P(e,r,n){return t.tidy(function(){var o=function(e,r){for(var n=[],o=0;o<l;o++){var i=A(e.get(o,0).valueOf(),e.get(o,1).valueOf(),o,r),u=i.x,s=i.y;n.push(s),n.push(u)}return t.tensor2d(n,[l,2])}(e,n);return e.toTensor().mul(t.scalar(r,"int32")).toFloat().add(o)})}function V(e,t,r){return q(this,void 0,void 0,function(){var n,o,i,u,s,l,c,f,h,d;return I(this,function(p){switch(p.label){case 0:return n=0,o=j(e),[4,Promise.all([B(e),B(t),B(o,"int32")])];case 1:return i=p.sent(),u=i[0],s=i[1],l=i[2],[4,B(c=P(l,r,s))];case 2:return f=p.sent(),h=Array.from(function(e,t){for(var r=t.shape[0],n=new Float32Array(r),o=0;o<r;o++){var i=t.get(o,0),u=t.get(o,1);n[o]=e.get(i,u,o)}return n}(u,l)),d=h.map(function(e,t){return n+=e,{position:{y:f.get(t,0),x:f.get(t,1)},part:a[t],score:e}}),o.dispose(),c.dispose(),[2,{keypoints:d,score:n/d.length}]}})})}var Y="https://storage.googleapis.com/tfjs-models/savedmodel/posenet/mobilenet/",D="https://storage.googleapis.com/tfjs-models/savedmodel/posenet/resnet50/";var F=function(){function e(e,r,n){this.model=e;var o=this.model.inputs[0].shape;t.util.assert(!(o[1]!==r&&-1!==o[1]||o[2]!==r&&-1!==o[2]),function(){return"Input shape ["+o[1]+", "+o[2]+"] must both be equal to "+r+" or -1"}),this.inputResolution=r,this.outputStride=n}return e.prototype.predict=function(e){var r=this;return t.tidy(function(){var n=function(e){return t.tidy(function(){"int32"===e.dtype&&(e=e.toFloat());var r=t.tensor([-123.15,-115.9,-103.06]);return e.add(r)})}(e).expandDims(0),o=r.model.predict(n),i=o[0],u=o[1],s=o[2];return{heatmapScores:o[3].squeeze().sigmoid(),offsets:s.squeeze(),displacementFwd:i.squeeze(),displacementBwd:u.squeeze()}})},e.prototype.dispose=function(){this.model.dispose()},e}(),K={architecture:"MobileNetV1",outputStride:16,inputResolution:513,multiplier:.75};var Q={flipHorizontal:!1,decodingMethod:"multi-person",maxDetections:5,scoreThreshold:.5,nmsRadius:20};var X=function(){function e(e){this.baseModel=e}return e.prototype.estimatePoses=function(e,r){return void 0===r&&(r=Q),q(this,void 0,void 0,function(){var o,i,u,s,a,l,c,f,h,d,p,m,g,v,y,b,w,x,_,E,M,S,R,O,N,j,A=this;return I(this,function(P){switch(P.label){case 0:return r=function(e){var t=["single-person","multi-person"];if(null==(e=e||Q).flipHorizontal&&(e.flipHorizontal=!1),null==e.decodingMethod&&(e.decodingMethod="multi-person"),t.indexOf(e.decodingMethod)<0)throw new Error("Invalid decoding method "+e.decodingMethod+". Should be one of "+t);if("multi-person"===e.decodingMethod){if(null==e.maxDetections&&(e.maxDetections=5),e.maxDetections<=0)throw new Error("Invalid maxDetections "+e.maxDetections+". Should be > 0 for decodingMethod "+e.decodingMethod+".");if(null==e.scoreThreshold&&(e.scoreThreshold=.5),e.scoreThreshold<0||e.scoreThreshold>1)throw new Error("Invalid scoreThreshold "+e.scoreThreshold+". Should be in range [0.0, 1.0] for decodingMethod "+e.decodingMethod+".");if(null==e.nmsRadius&&(e.nmsRadius=20),e.nmsRadius<=0)throw new Error("Invalid nmsRadius "+e.nmsRadius+". Should be positive for decodingMethod "+e.decodingMethod+".")}return e}(r),o=this.baseModel.outputStride,i=this.baseModel.inputResolution,function(e){t.util.assert("number"==typeof e,function(){return"outputStride is not a number"}),t.util.assert(n.indexOf(e)>=0,function(){return"outputStride of "+e+" is invalid. It must be either 8, 16, or 32"})}(o),function(e,r){t.util.assert("number"==typeof e,function(){return"resolution is not a number"}),t.util.assert((e-1)%r==0,function(){return"resolution of "+e+" is invalid for output stride "+r+"."})}(this.baseModel.inputResolution,o),u=z(e),s=u[0],a=u[1],c=(l=[0,0])[0],f=l[1],d=(h=[0,0,0,0])[0],p=h[1],m=h[2],g=h[3],c=i,f=i,x=t.tidy(function(){var t=H(e,[c,f]),r=t.resized,n=t.paddedBy;return d=n[0][0],p=n[0][1],m=n[1][0],g=n[1][1],A.baseModel.predict(r)}),v=x.heatmapScores,y=x.offsets,b=x.displacementFwd,w=x.displacementBwd,[4,function(e){return q(this,void 0,void 0,function(){return I(this,function(t){return[2,Promise.all(e.map(function(e){return B(e,"float32")}))]})})}([v,y,b,w])];case 1:return _=P.sent(),E=_[0],M=_[1],S=_[2],R=_[3],"multi-person"!==r.decodingMethod?[3,3]:[4,k(E,M,S,R,o,r.maxDetections,r.scoreThreshold,r.nmsRadius)];case 2:return O=P.sent(),[3,5];case 3:return[4,V(v,y,o)];case 4:N=P.sent(),O=[N],P.label=5;case 5:return j=function(e,t,r,n,o){return void 0===n&&(n=0),void 0===o&&(o=0),1===r&&1===t&&0===n&&0===o?e:e.map(function(e){return T(e,t,r,n,o)})}(O,(s+d+p)/c,(a+m+g)/f,-d,-m),r.flipHorizontal&&(j=function(e,t){return t<=0?e:e.map(function(e){return function(e,t){return{score:e.score,keypoints:e.keypoints.map(function(e){var r=e.score,n=e.part,o=e.position;return{score:r,part:n,position:{x:t-1-o.x,y:o.y}}})}}(e,t)})}(j,a)),v.dispose(),y.dispose(),b.dispose(),w.dispose(),[2,j]}})})},e.prototype.dispose=function(){this.baseModel.dispose()},e}();function W(e){return q(this,void 0,void 0,function(){var n,i,u,s,a,l,c;return I(this,function(f){switch(f.label){case 0:if(n=e.inputResolution,i=e.outputStride,u=e.quantBytes,s=e.multiplier,null==t)throw new Error("Cannot find TensorFlow.js. If you are using a <script> tag, please also include @tensorflow/tfjs on the page before using this\n        model.");return a=function(e,t,r,n){var o={1:"100",.75:"075",.5:"050"},i="model-stride"+t+".json";return 4==n?Y+"float/"+o[r]+"/"+i:Y+"quant"+n+"/"+o[r]+"/"+i}(0,i,s,u),[4,r.loadGraphModel(e.modelUrl||a)];case 1:return l=f.sent(),c=new o(l,n,i),[2,new X(c)]}})})}function C(e){return q(this,void 0,void 0,function(){var n,o,i,u,s,a;return I(this,function(l){switch(l.label){case 0:if(n=e.inputResolution,o=e.outputStride,i=e.quantBytes,null==t)throw new Error("Cannot find TensorFlow.js. If you are using a <script> tag, please also include @tensorflow/tfjs on the page before using this\n        model.");return u=function(e,t){var r="model-stride"+e+".json";return 4==t?D+"float/"+r:D+"quant"+t+"/"+r}(o,i),[4,r.loadGraphModel(e.modelUrl||u)];case 1:return s=l.sent(),a=new F(s,n,o),[2,new X(a)]}})})}e.decodeMultiplePoses=k,e.decodeSinglePose=V,e.MobileNet=o,e.partChannels=["left_face","right_face","right_upper_leg_front","right_lower_leg_back","right_upper_leg_back","left_lower_leg_front","left_upper_leg_front","left_upper_leg_back","left_lower_leg_back","right_feet","right_lower_leg_front","left_feet","torso_front","torso_back","right_upper_arm_front","right_upper_arm_back","right_lower_arm_back","left_lower_arm_front","left_upper_arm_front","left_upper_arm_back","left_lower_arm_back","right_hand","right_lower_arm_front","left_hand"],e.partIds=c,e.partNames=a,e.poseChain=f,e.load=function(e){return void 0===e&&(e=K),q(this,void 0,void 0,function(){return I(this,function(t){return"ResNet50"===(e=function(e){var t=["MobileNetV1","ResNet50"],r={MobileNetV1:[8,16,32],ResNet50:[32,16]},n=[161,193,257,289,321,353,385,417,449,481,513,801],o={MobileNetV1:[.5,.75,1],ResNet50:[1]},i=[1,2,4];if(null==(e=e||K).architecture&&(e.architecture="MobileNetV1"),t.indexOf(e.architecture)<0)throw new Error("Invalid architecture "+e.architecture+". Should be one of "+t);if(null==e.outputStride&&(e.outputStride=16),r[e.architecture].indexOf(e.outputStride)<0)throw new Error("Invalid outputStride "+e.outputStride+". Should be one of "+r[e.architecture]+" for architecutre "+e.architecture+".");if(null==e.inputResolution&&(e.inputResolution=513),n.indexOf(e.inputResolution)<0)throw new Error("Invalid inputResolution "+e.inputResolution+". Should be one of "+n+" for architecutre "+e.architecture+".");if(null==e.multiplier&&(e.multiplier=1),o[e.architecture].indexOf(e.multiplier)<0)throw new Error("Invalid multiplier "+e.multiplier+". Should be one of "+o[e.architecture]+" for architecutre "+e.architecture+".");if(null==e.quantBytes&&(e.quantBytes=4),i.indexOf(e.quantBytes)<0)throw new Error("Invalid quantBytes "+e.quantBytes+". Should be one of "+i+" for architecutre "+e.architecture+".");return e}(e)).architecture?[2,C(e)]:"MobileNetV1"===e.architecture?[2,W(e)]:[2,null]})})},e.PoseNet=X,e.getAdjacentKeyPoints=function(e,t){return h.reduce(function(r,n){var o=n[0],i=n[1];return function(e,t,r){return e<r||t<r}(e[o].score,e[i].score,t)?r:(r.push([e[o],e[i]]),r)},[])},e.getBoundingBox=N,e.getBoundingBoxPoints=function(e){var t=N(e),r=t.minX,n=t.minY,o=t.maxX,i=t.maxY;return[{x:r,y:n},{x:o,y:n},{x:o,y:i},{x:r,y:i}]},e.scalePose=T,Object.defineProperty(e,"__esModule",{value:!0})});
