<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学生站立监测系统 - PoseNet版</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 15px;
            background: linear-gradient(135deg, #4a6fa5 0%, #3a5a8f 100%);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header h1 {
            margin: 0;
            font-size: 28px;
        }
        .header p {
            margin: 5px 0 0;
            font-size: 16px;
            opacity: 0.9;
        }
        .video-container {
            position: relative;
            margin-bottom: 20px;
            background: #222;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #video {
            display: block;
            width: 100%;
            transform: rotateY(180deg);
        }
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            transform: rotateY(180deg);
        }
        .camera-selector {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 0 0 8px 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-top: 1px solid #eee;
        }
        .camera-selector label {
            font-weight: bold;
            color: #495057;
        }
        .camera-selector select {
            flex: 1;
            max-width: 300px;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
            padding: 18px;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .control-group label {
            font-weight: 500;
            color: #495057;
            white-space: nowrap;
        }
        .threshold-control {
            min-width: 280px;
        }
        .threshold-value {
            min-width: 45px;
            text-align: center;
            font-weight: bold;
            color: #4a6fa5;
        }
        button {
            padding: 10px 18px;
            background: linear-gradient(to bottom, #4a6fa5 0%, #3a5a8f 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover {
            background: linear-gradient(to bottom, #3a5a8f 0%, #2a4a7f 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        button.secondary {
            background: linear-gradient(to bottom, #6c757d 0%, #5a6268 100%);
        }
        button.secondary:hover {
            background: linear-gradient(to bottom, #5a6268 0%, #495057 100%);
        }
        select, input[type="range"] {
            padding: 9px 12px;
            border-radius: 6px;
            border: 1px solid #ced4da;
            background-color: white;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        select:focus, input[type="range"]:focus {
            outline: none;
            border-color: #4a6fa5;
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.2);
        }
        input[type="range"] {
            -webkit-appearance: none;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            padding: 0;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #4a6fa5;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 18px;
            margin-bottom: 25px;
        }
        .stat-card {
            padding: 18px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .stat-card.standing {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            color: #2E7D32;
            border-left: 4px solid #4CAF50;
        }
        .stat-card.sitting {
            background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);
            color: #C62828;
            border-left: 4px solid #F44336;
        }
        .stat-card.unknown {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            color: #1565C0;
            border-left: 4px solid #2196F3;
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin: 8px 0;
        }
        .stat-card div:last-child {
            font-size: 15px;
            font-weight: 500;
        }
        .student-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 18px;
            margin-top: 25px;
        }
        .student-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: all 0.3s;
            text-align: center;
            padding: 12px;
        }
        .student-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        .student-card.standing {
            border-left: 5px solid #4CAF50;
        }
        .student-card.sitting {
            border-left: 5px solid #F44336;
        }
        .student-card.unknown {
            border-left: 5px solid #2196F3;
            opacity: 0.8;
        }
        .student-avatar {
            width: 100%;
            height: 130px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #eee;
            background-color: #f5f5f5;
        }
        .student-name {
            font-weight: bold;
            margin-bottom: 6px;
            color: #333;
            font-size: 15px;
        }
        .student-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 6px;
        }
        .standing .student-status {
            background: #E8F5E9;
            color: #2E7D32;
        }
        .sitting .student-status {
            background: #FFEBEE;
            color: #C62828;
        }
        .unknown .student-status {
            background: #E3F2FD;
            color: #1565C0;
        }
        .confidence-meter {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }
        .confidence-bar {
            flex: 1;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
        }
        .confidence-fill {
            height: 100%;
            background: #4a6fa5;
            border-radius: 2px;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            flex-direction: column;
            z-index: 1000;
            font-size: 18px;
        }
        .loading-spinner {
            border: 5px solid rgba(255,255,255,0.2);
            border-top: 5px solid #4a6fa5;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 25px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loading-text {
            max-width: 300px;
            text-align: center;
            line-height: 1.6;
        }
        .alert-banner {
            padding: 12px;
            background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);
            color: #C62828;
            text-align: center;
            border-radius: 6px;
            margin-bottom: 25px;
            display: none;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(198,40,40,0.1);
            border-left: 4px solid #F44336;
        }
        .camera-error {
            padding: 15px;
            background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
            color: #E65100;
            text-align: center;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
            border-left: 4px solid #FF9800;
        }
        .permission-help {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            padding: 18px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2196F3;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .permission-help h3 {
            margin-top: 0;
            color: #1565C0;
        }
        .permission-help p {
            margin: 8px 0;
            line-height: 1.5;
        }
        .empty-state {
            grid-column: 1/-1;
            text-align: center;
            padding: 50px 20px;
            color: #666;
            font-size: 16px;
        }
        .empty-state img {
            width: 80px;
            opacity: 0.6;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div id="loading-text">正在初始化系统，请稍候...</div>
    </div>

    <div class="container" id="main-container" style="display: none;">
        <div class="header">
            <h1>学生站立读书监测系统</h1>
            <p>PoseNet版 - 专注头部检测</p>
        </div>

        <div class="alert-banner" id="alert-banner">
            警告：检测到多名学生坐下未读书！
        </div>

        <div class="camera-error" id="camera-error"></div>

        <div class="permission-help" id="permission-help" style="display: none;">
            <h3>无法访问摄像头？</h3>
            <p>1. 请点击浏览器地址栏的摄像头图标，选择"允许"</p>
            <p>2. 检查摄像头是否被其他程序占用</p>
            <p>3. 尝试刷新页面或使用其他浏览器</p>
        </div>

        <div class="stats-container">
            <div class="stat-card standing">
                <div class="stat-value" id="standing-count">0</div>
                <div>站立读书</div>
            </div>
            <div class="stat-card sitting">
                <div class="stat-value" id="sitting-count">0</div>
                <div>坐下未读书</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-count">0</div>
                <div>总人数</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="standing-ratio">0%</div>
                <div>站立比例</div>
            </div>
            <div class="stat-card unknown">
                <div class="stat-value" id="unknown-count">0</div>
                <div>状态未知</div>
            </div>
        </div>

        <div class="video-container">
            <video id="video" width="800" height="600" autoplay muted></video>
            <canvas id="canvas" width="800" height="600"></canvas>
            <div class="camera-selector" id="camera-selector" style="display: none;">
                <label for="camera-select">选择摄像头:</label>
                <select id="camera-select"></select>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <button id="start-btn">开始监测</button>
                <button id="stop-btn" class="secondary" disabled>停止监测</button>
                <button id="toggle-pose-btn">显示姿态</button>
            </div>

            <div class="control-group threshold-control">
                <label for="standing-threshold">站立阈值:</label>
                <input type="range" id="standing-threshold" min="0.1" max="0.9" step="0.05" value="0.3">
                <span class="threshold-value" id="threshold-value">0.30</span>
            </div>

            <div class="control-group">
                <label for="student-filter">筛选:</label>
                <select id="student-filter">
                    <option value="all">所有学生</option>
                    <option value="standing">站立的学生</option>
                    <option value="sitting">坐下的学生</option>
                    <option value="unknown">状态未知</option>
                </select>
            </div>
        </div>

        <h2 style="margin-top: 25px; color: #4a6fa5;">学生列表</h2>
        <div class="student-list" id="student-list">
            <div class="empty-state">
                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLXVzZXJzIj48cGF0aCBkPSJNMTYgMjF2LTJhNCA0IDAgMCAwLTQtNEg2YTQgNCAwIDAgMC00IDR2MiIvPjxjaXJjbGUgY3g9IjkiIGN5PSI3IiByPSI0Ii8+PHBhdGggZD0iTTIyIDIxdi0yYTQgNCAwIDAgMC0zLTMuODciLz48cGF0aCBkPSJNMTYgMy4xM2E0IDQgMCAwIDEgMCA3Ljc1Ii8+PC9zdmc+" alt="Empty">
                <div>暂无学生数据，请开始监测</div>
            </div>
        </div>
    </div>

    <!-- 加载 TensorFlow.js 和 PoseNet -->
    <script src="./js/tf.min.js"></script>
    <script src="./js/posenet.min.js"></script>

    <script>
        // 全局变量
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const togglePoseBtn = document.getElementById('toggle-pose-btn');
        const standingCountEl = document.getElementById('standing-count');
        const sittingCountEl = document.getElementById('sitting-count');
        const totalCountEl = document.getElementById('total-count');
        const standingRatioEl = document.getElementById('standing-ratio');
        const unknownCountEl = document.getElementById('unknown-count');
        const alertBanner = document.getElementById('alert-banner');
        const thresholdSlider = document.getElementById('standing-threshold');
        const thresholdValue = document.getElementById('threshold-value');
        const studentFilter = document.getElementById('student-filter');
        const studentListEl = document.getElementById('student-list');
        const cameraSelector = document.getElementById('camera-selector');
        const cameraSelect = document.getElementById('camera-select');
        const cameraError = document.getElementById('camera-error');
        const permissionHelp = document.getElementById('permission-help');
        const loadingElement = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const mainContainer = document.getElementById('main-container');

        // 配置参数
        const config = {
            detectionInterval: 3000,  // 检测间隔(毫秒)
            minPoseConfidence: 0.3,  // 最小姿态置信度
            minHeadConfidence: 0.5,   // 最小头部置信度
            studentTimeout: 5000,     // 学生超时时间(毫秒)
            matchDistance: 150,       // 匹配距离(像素)
            headBoxScale: 2.8,        // 头部框缩放比例
            minStandingHeightRatio: 1.8, // 站立高度比例阈值
            minHeadSize: 40           // 最小头部尺寸(像素)
        };

        // 学生状态常量
        const STUDENT_STATUS = {
            UNKNOWN: 'unknown',
            STANDING: 'standing',
            SITTING: 'sitting'
        };

        // 状态变量
        let isMonitoring = false;
        let isShowingPose = false;
        let detectionInterval;
        let posenetModel;
        let currentPoses = [];
        let students = [];
        let studentIdCounter = 1;
        let standingThreshold = parseFloat(thresholdSlider.value);
        let currentStream = null;
        let availableCameras = [];

        // 初始化系统
        async function initialize() {
            try {
                showLoading("正在加载AI模型...");
                
                // 加载 PoseNet 模型
                await loadPosenetModel();
                
                // 初始化摄像头
                await initCamera();
                
                hideLoading();
                mainContainer.style.display = 'block';
                startBtn.disabled = false;
                
                console.log("系统初始化完成");
            } catch (err) {
                showLoading(`初始化失败: ${err.message}`);
                console.error("初始化失败:", err);
            }
        }

        // 加载 PoseNet 模型
        async function loadPosenetModel() {
            posenetModel = await posenet.load({
                architecture: 'MobileNetV1',
                outputStride: 16,
                inputResolution: 801,
                modelUrl: 'models/model-stride16.json',
                multiplier: 0.75
            });
            console.log("PoseNet 模型加载完成");
        }

        // 初始化摄像头
        async function initCamera() {
            try {
                // 检查媒体设备支持
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error("您的浏览器不支持摄像头访问");
                }
                
                // 获取摄像头列表
                await getCameraList();
                
                // 如果有摄像头设备，选择第一个
                if (availableCameras.length > 0) {
                    await switchCamera(availableCameras[0].deviceId);
                    cameraSelector.style.display = 'flex';
                } else {
                    throw new Error("未检测到可用的摄像头设备");
                }
                
            } catch (err) {
                console.error("摄像头初始化错误:", err);
                showCameraError(err.message);
                throw err;
            }
        }

        // 获取摄像头列表
        async function getCameraList() {
            try {
                // 先获取权限
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                stopStream(stream);
                
                // 枚举设备
                const devices = await navigator.mediaDevices.enumerateDevices();
                availableCameras = devices.filter(device => device.kind === 'videoinput');
                
                // 更新选择器
                cameraSelect.innerHTML = '';
                availableCameras.forEach((camera, index) => {
                    const option = document.createElement('option');
                    option.value = camera.deviceId;
                    option.text = camera.label || `摄像头 ${index + 1}`;
                    cameraSelect.appendChild(option);
                });
                
            } catch (err) {
                console.error("获取摄像头列表失败:", err);
                throw new Error("无法访问摄像头设备");
            }
        }

        // 切换摄像头
        async function switchCamera(deviceId) {
            try {
                // 停止当前流
                stopStream(currentStream);
                
                // 获取新流
                currentStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        deviceId: { exact: deviceId },
                        width: { ideal: 800 },
                        height: { ideal: 600 },
                        frameRate: { ideal: 15 }
                    }
                });
                
                video.srcObject = currentStream;
                
                // 等待视频准备就绪
                await new Promise((resolve, reject) => {
                    const timer = setTimeout(() => {
                        reject(new Error("视频加载超时"));
                    }, 5000);
                    
                    video.onloadedmetadata = () => {
                        clearTimeout(timer);
                        // 设置canvas尺寸与视频一致
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        resolve();
                    };
                    
                    video.onerror = () => {
                        clearTimeout(timer);
                        reject(new Error("视频加载失败"));
                    };
                });
                
                console.log("摄像头切换成功");
                
                // 如果正在监测，重新开始
                if (isMonitoring) {
                    startMonitoring();
                }
                
            } catch (err) {
                console.error("切换摄像头失败:", err);
                showCameraError(`摄像头切换失败: ${err.message}`);
                throw err;
            }
        }

        // 停止媒体流
        function stopStream(stream) {
            if (stream) {
                stream.getTracks().forEach(track => {
                    track.stop();
                });
            }
        }

        // 开始监测
        function startMonitoring() {
            if (isMonitoring) return;
            
            isMonitoring = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            
            // 清空之前的数据
            students = [];
            studentIdCounter = 1;
            renderStudentList();
            
            // 立即执行一次检测
            detect();
            
            // 设置定时检测
            detectionInterval = setInterval(detect, config.detectionInterval);
            
            console.log("监测已启动");
        }

        // 停止监测
        function stopMonitoring() {
            if (!isMonitoring) return;
            
            isMonitoring = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            clearInterval(detectionInterval);
            clearCanvas();
            
            // 重置统计数据
            updateStatistics([]);
            
            console.log("监测已停止");
        }

        // 主检测函数
        async function detect() {
            if (!isMonitoring) return;
            
            try {
                // 检测姿态
                const poses = await detectPoses();
                currentPoses = poses;
                
                // 更新学生数据
                await updateStudents(poses);
                
                // 更新显示
                updateStatistics(poses);
                renderStudentList();
                
                // 绘制姿态
                if (isShowingPose) {
                    drawDetectionResults(poses);
                } else {
                    clearCanvas();
                }
            } catch (err) {
                console.error("检测出错:", err);
            }
        }

        // 检测姿态
        async function detectPoses() {
            if (!posenetModel) return [];
            
            return await posenetModel.estimatePoses(video, {
                flipHorizontal: false,
                maxPoses: 10,
                scoreThreshold: config.minPoseConfidence,
                nmsRadius: 20
            });
        }

        // 更新学生数据
        async function updateStudents(poses) {
            const now = Date.now();
            const offscreenCanvas = document.createElement('canvas');
            offscreenCanvas.width = video.videoWidth;
            offscreenCanvas.height = video.videoHeight;
            const offscreenCtx = offscreenCanvas.getContext('2d');
            offscreenCtx.drawImage(video, 0, 0);
            
            // 1. 首先处理姿态检测结果
            for (const pose of poses) {
                await processPose(pose, offscreenCanvas, now);
            }
            
            // 2. 清理超时的学生
            cleanupOldStudents(now);
            
            // 3. 更新未匹配姿态的学生状态
            updateUnmatchedStudents();
        }

        // 处理姿态数据
        async function processPose(pose, offscreenCanvas, timestamp) {
            const isStanding = checkIfStanding(pose.keypoints);
            const headBox = getHeadBoundingBox(pose.keypoints);
            
            // 如果头部区域太小，忽略这个姿态
            if (headBox.width < config.minHeadSize || headBox.height < config.minHeadSize) {
                return;
            }
            
            // 查找匹配的学生（基于头部位置）
            const student = findClosestStudent(headBox, timestamp);
            
            if (student) {
                // 更新学生位置和头像
                student.headPosition = headBox;
                student.avatar = await captureHeadAvatar(headBox, offscreenCanvas);
                student.poseConfidence = Math.round(pose.score * 100);
                student.lastSeen = timestamp;
                student.status = isStanding ? STUDENT_STATUS.STANDING : STUDENT_STATUS.SITTING;
            } else {
                // 创建新学生
                const newStudent = {
                    id: studentIdCounter++,
                    name: `学生 ${studentIdCounter}`,
                    headPosition: headBox,
                    status: isStanding ? STUDENT_STATUS.STANDING : STUDENT_STATUS.SITTING,
                    avatar: await captureHeadAvatar(headBox, offscreenCanvas),
                    poseConfidence: Math.round(pose.score * 100),
                    lastSeen: timestamp,
                    hasPose: true
                };
                students.push(newStudent);
            }
        }

        // 获取头部边界框（基于鼻子和眼睛位置）
        function getHeadBoundingBox(keypoints) {
            const minConfidence = config.minHeadConfidence;
            
            // 获取必要的关键点
            const nose = keypoints.find(k => k.part === 'nose');
            const leftEye = keypoints.find(k => k.part === 'leftEye');
            const rightEye = keypoints.find(k => k.part === 'rightEye');
            const leftEar = keypoints.find(k => k.part === 'leftEar');
            const rightEar = keypoints.find(k => k.part === 'rightEar');
            
            // 计算头部中心点
            let centerX = 0, centerY = 0;
            let count = 0;
            
            if (nose && nose.score >= minConfidence) {
                centerX += nose.position.x;
                centerY += nose.position.y;
                count++;
            }
            
            if (leftEye && leftEye.score >= minConfidence) {
                centerX += leftEye.position.x;
                centerY += leftEye.position.y;
                count++;
            }
            
            if (rightEye && rightEye.score >= minConfidence) {
                centerX += rightEye.position.x;
                centerY += rightEye.position.y;
                count++;
            }
            
            if (count === 0) {
                return { x: 0, y: 0, width: 0, height: 0 };
            }
            
            centerX /= count;
            centerY /= count;
            
            // 计算头部大小（基于眼睛和耳朵的距离）
            let headSize = 0;
            if (leftEye && rightEye && leftEye.score >= minConfidence && rightEye.score >= minConfidence) {
                // 使用眼睛之间的距离作为基准
                headSize = Math.sqrt(
                    Math.pow(leftEye.position.x - rightEye.position.x, 2) +
                    Math.pow(leftEye.position.y - rightEye.position.y, 2)
                ) * 2; // 眼睛距离大约是头部宽度的一半
            } else if (nose && leftEye && nose.score >= minConfidence && leftEye.score >= minConfidence) {
                // 使用鼻子到眼睛的距离
                headSize = Math.sqrt(
                    Math.pow(nose.position.x - leftEye.position.x, 2) +
                    Math.pow(nose.position.y - leftEye.position.y, 2)
                ) * 3;
            } else if (nose && rightEye && nose.score >= minConfidence && rightEye.score >= minConfidence) {
                // 使用鼻子到右眼的距离
                headSize = Math.sqrt(
                    Math.pow(nose.position.x - rightEye.position.x, 2) +
                    Math.pow(nose.position.y - rightEye.position.y, 2)
                ) * 3;
            } else {
                // 默认头部大小
                headSize = 80;
            }
            
            // 确保头部大小不小于最小值
            headSize = Math.max(headSize, config.minHeadSize);
            
            return {
                x: centerX - headSize / 2,
                y: centerY - headSize / 2,
                width: headSize,
                height: headSize
            };
        }

        // 判断是否站立 - 优化后的版本
        function checkIfStanding(keypoints) {
            const minConfidence = config.minPoseConfidence;
            
            // 获取必要的关键点
            const nose = keypoints.find(k => k.part === 'nose');
            const leftEye = keypoints.find(k => k.part === 'leftEye');
            const rightEye = keypoints.find(k => k.part === 'rightEye');
            const leftHip = keypoints.find(k => k.part === 'leftHip');
            const rightHip = keypoints.find(k => k.part === 'rightHip');
            const leftKnee = keypoints.find(k => k.part === 'leftKnee');
            const rightKnee = keypoints.find(k => k.part === 'rightKnee');
            const leftAnkle = keypoints.find(k => k.part === 'leftAnkle');
            const rightAnkle = keypoints.find(k => k.part === 'rightAnkle');
            
            // 检查关键点置信度
            const hasValidUpperBody = [nose, leftEye, rightEye, leftHip, rightHip].every(
                kp => kp && kp.score >= minConfidence
            );
            
            if (!hasValidUpperBody) return false;
            
            // 计算眼睛中点
            const eyeCenter = {
                x: (leftEye.position.x + rightEye.position.x) / 2,
                y: (leftEye.position.y + rightEye.position.y) / 2
            };
            
            // 计算髋部中点
            const hipCenter = {
                x: (leftHip.position.x + rightHip.position.x) / 2,
                y: (leftHip.position.y + rightHip.position.y) / 2
            };
            
            // 计算眼睛到髋部的垂直距离
            const eyeToHipDist = Math.abs(eyeCenter.y - hipCenter.y);
            
            // 计算髋部到膝盖的距离（如果膝盖可见）
            let hipToKneeDist = 0;
            let hasKnee = false;
            
            if (leftKnee && leftKnee.score >= minConfidence && leftHip.score >= minConfidence) {
                hipToKneeDist = Math.abs(leftHip.position.y - leftKnee.position.y);
                hasKnee = true;
            } else if (rightKnee && rightKnee.score >= minConfidence && rightHip.score >= minConfidence) {
                hipToKneeDist = Math.abs(rightHip.position.y - rightKnee.position.y);
                hasKnee = true;
            }
            
            // 计算膝盖到脚踝的距离（如果脚踝可见）
            let kneeToAnkleDist = 0;
            let hasAnkle = false;
            
            if (leftAnkle && leftAnkle.score >= minConfidence && leftKnee && leftKnee.score >= minConfidence) {
                kneeToAnkleDist = Math.abs(leftKnee.position.y - leftAnkle.position.y);
                hasAnkle = true;
            } else if (rightAnkle && rightAnkle.score >= minConfidence && rightKnee && rightKnee.score >= minConfidence) {
                kneeToAnkleDist = Math.abs(rightKnee.position.y - rightAnkle.position.y);
                hasAnkle = true;
            }
            
            // 计算比例 - 新的站立判定逻辑
            let ratio = 0;
            if (hasKnee && hasAnkle) {
                // 如果有膝盖和脚踝数据，使用完整的腿部比例
                const legLength = hipToKneeDist + kneeToAnkleDist;
                ratio = legLength / eyeToHipDist;
            } else if (hasKnee) {
                // 如果只有膝盖数据，使用髋部到膝盖的比例
                ratio = hipToKneeDist / eyeToHipDist;
            } else {
                // 如果没有下肢数据，使用上半身比例
                const noseToHipDist = Math.abs(nose.position.y - hipCenter.y);
                ratio = eyeToHipDist / noseToHipDist;
            }
            
            // 计算身高与躯干的比例，防止误判
            const heightRatio = (eyeToHipDist + (hasKnee ? hipToKneeDist : 0) + (hasAnkle ? kneeToAnkleDist : 0)) / eyeToHipDist;
            
            // 判断是否站立
            return ratio > standingThreshold && heightRatio > config.minStandingHeightRatio;
        }

        // 捕获头部头像
        function captureHeadAvatar(headBox, sourceCanvas) {
            return new Promise((resolve) => {
                try {
                    const size = Math.max(headBox.width, headBox.height) * config.headBoxScale;
                    const x = Math.max(0, headBox.x + headBox.width / 2 - size / 2);
                    const y = Math.max(0, headBox.y + headBox.height / 2 - size / 2);
                    const width = Math.min(size, sourceCanvas.width - x);
                    const height = Math.min(size, sourceCanvas.height - y);
                    
                    const avatarCanvas = document.createElement('canvas');
                    avatarCanvas.width = size;
                    avatarCanvas.height = size;
                    const avatarCtx = avatarCanvas.getContext('2d');
                    
                    // 填充白色背景（防止边缘透明）
                    avatarCtx.fillStyle = 'white';
                    avatarCtx.fillRect(0, 0, size, size);
                    
                    // 绘制头像
                    avatarCtx.drawImage(
                        sourceCanvas,
                        x, y, width, height,
                        (size - width) / 2, (size - height) / 2, width, height
                    );
                    
                    setTimeout(() => {
                        resolve(avatarCanvas.toDataURL('image/jpeg', 0.7));
                    }, 0);
                } catch (err) {
                    console.error("捕获头像出错:", err);
                    resolve(getDefaultAvatar());
                }
            });
        }

        // 查找最近的学生
        function findClosestStudent(headBox, timestamp) {
            let closestStudent = null;
            let minDistance = Infinity;
            const now = timestamp || Date.now();
            
            for (const student of students) {
                // 跳过太久没见到的学生
                if (now - student.lastSeen > config.studentTimeout) continue;
                
                // 必须有头部位置才能匹配
                if (!student.headPosition) continue;
                
                const distance = calculateDistance(student.headPosition, headBox);
                
                if (distance < config.matchDistance && distance < minDistance) {
                    minDistance = distance;
                    closestStudent = student;
                }
            }
            
            return closestStudent;
        }

        // 计算距离
        function calculateDistance(pos1, pos2) {
            const center1 = {
                x: pos1.x + pos1.width / 2,
                y: pos1.y + pos1.height / 2
            };
            
            const center2 = {
                x: pos2.x + pos2.width / 2,
                y: pos2.y + pos2.height / 2
            };
            
            return Math.sqrt(
                Math.pow(center1.x - center2.x, 2) +
                Math.pow(center1.y - center2.y, 2)
            );
        }

        // 清理超时的学生
        function cleanupOldStudents(now = Date.now()) {
            students = students.filter(student => now - student.lastSeen < config.studentTimeout);
        }

        // 更新未匹配姿态的学生状态
        function updateUnmatchedStudents() {
            const now = Date.now();
            students.forEach(student => {
                // 如果没有检测到姿态，但之前有姿态信息，且超过一定时间未更新
                if (!student.hasPose && student.status !== STUDENT_STATUS.UNKNOWN) {
                    const timeSinceLastPose = now - student.lastSeen;
                    if (timeSinceLastPose > config.studentTimeout / 2) {
                        student.status = STUDENT_STATUS.UNKNOWN;
                    }
                }
                student.hasPose = false; // 重置标志，等待下一次检测
            });
        }

        // 更新统计信息
        function updateStatistics(poses) {
            let standingCount = 0;
            let sittingCount = 0;
            let unknownCount = 0;
            
            students.forEach(student => {
                switch(student.status) {
                    case STUDENT_STATUS.STANDING:
                        standingCount++;
                        break;
                    case STUDENT_STATUS.SITTING:
                        sittingCount++;
                        break;
                    default:
                        unknownCount++;
                }
            });
            
            const totalCount = standingCount + sittingCount; // 不包含未知状态
            
            // 计算站立比例（基于已知状态的学生）
            const ratio = totalCount > 0 ? Math.round((standingCount / totalCount) * 100) : 0;
            
            // 更新UI
            standingCountEl.textContent = standingCount;
            sittingCountEl.textContent = sittingCount;
            totalCountEl.textContent = totalCount;
            standingRatioEl.textContent = `${ratio}%`;
            unknownCountEl.textContent = unknownCount;
            
            // 警告逻辑
            if (totalCount > 0 && sittingCount > totalCount / 2) {
                alertBanner.style.display = 'block';
            } else {
                alertBanner.style.display = 'none';
            }
        }

        // 渲染学生列表
        function renderStudentList() {
            const filterValue = studentFilter.value;
            const filteredStudents = students.filter(student => {
                if (filterValue === 'all') return true;
                if (filterValue === 'standing') return student.status === STUDENT_STATUS.STANDING;
                if (filterValue === 'sitting') return student.status === STUDENT_STATUS.SITTING;
                if (filterValue === 'unknown') return student.status === STUDENT_STATUS.UNKNOWN;
                return true;
            });
            
            if (filteredStudents.length === 0) {
                studentListEl.innerHTML = `
                    <div class="empty-state">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLXVzZXJzIj48cGF0aCBkPSJNMTYgMjF2LTJhNCA0IDAgMCAwLTQtNEg2YTQgNCAwIDAgMC00IDR2MiIvPjxjaXJjbGUgY3g9IjkiIGN5PSI3IiByPSI0Ii8+PHBhdGggZD0iTTIyIDIxdi0yYTQgNCA0IDAgMCAwLTMtMy44NyIvPjxwYXRoIGQ9Ik0xNiAzLjEzYTQgNCAwIDAgMSAwIDcuNzUiLz48L3N2Zz4=" alt="Empty">
                        <div>没有检测到${filterValue === 'all' ? '' : 
                            filterValue === 'standing' ? '站立' : 
                            filterValue === 'sitting' ? '坐下' : '状态未知'}的学生</div>
                    </div>
                `;
                return;
            }
            
            const fragment = document.createDocumentFragment();
            
            filteredStudents.forEach(student => {
                const card = document.createElement('div');
                let statusClass = '';
                let statusText = '';
                let confidence = 0;
                
                switch(student.status) {
                    case STUDENT_STATUS.STANDING:
                        statusClass = 'standing';
                        statusText = '站立读书';
                        confidence = student.poseConfidence;
                        break;
                    case STUDENT_STATUS.SITTING:
                        statusClass = 'sitting';
                        statusText = '坐下未读书';
                        confidence = student.poseConfidence;
                        break;
                    default:
                        statusClass = 'unknown';
                        statusText = '状态未知';
                        confidence = student.poseConfidence || 0;
                }
                
                card.className = `student-card ${statusClass}`;
                
                card.innerHTML = `
                    <img class="student-avatar" src="${student.avatar || getDefaultAvatar()}" 
                         alt="${student.name}" onerror="this.src='${getDefaultAvatar()}'">
                    <div class="student-name">${student.name}</div>
                    <div class="student-status">${statusText}</div>
                    <div class="confidence-meter">
                        <span>置信度</span>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${confidence}%"></div>
                        </div>
                    </div>
                `;
                
                fragment.appendChild(card);
            });
            
            studentListEl.innerHTML = '';
            studentListEl.appendChild(fragment);
        }

        function getDefaultAvatar() {
            // 使用双引号并编码特殊字符
            return 'data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22100%22%20height%3D%22100%22%20viewBox%3D%220%200%20100%20100%22%3E%3Crect%20width%3D%22100%22%20height%3D%22100%22%20fill%3D%22%23eee%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-family%3D%22Arial%22%20font-size%3D%2214%22%20fill%3D%22%23666%22%20text-anchor%3D%22middle%22%20dominant-baseline%3D%22middle%22%3E%E6%97%A0%E5%A4%B4%E5%83%8F%3C%2Ftext%3E%3C%2Fsvg%3E';
        }

        // 绘制检测结果（姿态）
        function drawDetectionResults(poses) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            poses.forEach(pose => {
                if (pose.score >= config.minPoseConfidence) {
                    if (isShowingPose) {
                        drawKeypoints(pose.keypoints);
                        drawSkeleton(pose.keypoints);
                    }
                }
            });
        }

        // 绘制关键点
        function drawKeypoints(keypoints) {
            const minConfidence = config.minPoseConfidence;
            
            keypoints.forEach(keypoint => {
                if (keypoint.score >= minConfidence) {
                    const { y, x } = keypoint.position;
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fillStyle = 'aqua';
                    ctx.fill();
                }
            });
        }

        // 绘制骨架
        function drawSkeleton(keypoints) {
            const minConfidence = config.minPoseConfidence;
            const adjacentKeyPoints = posenet.getAdjacentKeyPoints(keypoints, minConfidence);
            
            adjacentKeyPoints.forEach(([firstKeypoint, secondKeypoint]) => {
                ctx.beginPath();
                ctx.moveTo(firstKeypoint.position.x, firstKeypoint.position.y);
                ctx.lineTo(secondKeypoint.position.y, secondKeypoint.position.y);
                ctx.lineWidth = 2;
                ctx.strokeStyle = 'aqua';
                ctx.stroke();
            });
        }

        // 清空画布
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // 显示加载状态
        function showLoading(message) {
            loadingText.textContent = message;
        }

        // 隐藏加载状态
        function hideLoading() {
            loadingElement.style.display = 'none';
            mainContainer.style.display = 'block';
        }

        // 显示摄像头错误
        function showCameraError(message) {
            cameraError.textContent = message;
            cameraError.style.display = 'block';
            permissionHelp.style.display = 'block';
        }

        // 切换姿态显示
        function togglePoseDisplay() {
            isShowingPose = !isShowingPose;
            togglePoseBtn.textContent = isShowingPose ? '隐藏姿态' : '显示姿态';
            
            if (isShowingPose && currentPoses.length > 0) {
                drawDetectionResults(currentPoses);
            } else {
                clearCanvas();
            }
        }

        // 事件监听
        startBtn.addEventListener('click', startMonitoring);
        stopBtn.addEventListener('click', stopMonitoring);
        togglePoseBtn.addEventListener('click', togglePoseDisplay);
        studentFilter.addEventListener('change', renderStudentList);
        thresholdSlider.addEventListener('input', function() {
            standingThreshold = parseFloat(this.value);
            thresholdValue.textContent = standingThreshold.toFixed(2);
        });
        cameraSelect.addEventListener('change', async () => {
            try {
                loadingElement.style.display = 'flex';
                loadingText.textContent = "正在切换摄像头...";
                await switchCamera(cameraSelect.value);
                loadingElement.style.display = 'none';
            } catch (err) {
                loadingElement.style.display = 'none';
                console.error("切换摄像头失败:", err);
            }
        });

        // 初始化
        initialize();
    </script>
</body>
</html>
